å¯¹äº`â€œä¸ºä»€ä¹ˆè¦è¿›è¡Œä¾èµ–é¢„æ„å»º?"`è¿™ä¸ªé—®é¢˜[vite æ–‡æ¡£](https://vitejs.cn/guide/dep-pre-bundling.html#%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA)å·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œé‚£ä¹ˆé¢„æ„å»ºå¤§æ¦‚çš„æµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

## å¯åŠ¨é¢„æ„å»º

ä»æ–‡æ¡£ä¸­æˆ‘ä»¬çŸ¥é“åœ¨æœåŠ¡å¯åŠ¨å‰ä¼šè¿›è¡Œé¢„æ„å»ºï¼Œå¯¹åº”æºç ä½ç½®åœ¨`src/node/server/index.ts`,é¢„æ„å»ºçš„å‡½æ•°åæ˜¯`optimizeDeps`

```
...
const runOptimize = async () => {
    if (config.cacheDir) {
      server._isRunningOptimizer = true;
      try {
        server._optimizeDepsMetadata = await optimizeDeps(config);
      } finally {
        server._isRunningOptimizer = false;
      }
      server._registerMissingImport = createMissingImporterRegisterFn(server);
    }
  };

...
await runOptimize();
...
```

## å¼€å§‹é¢„æ„å»º

å‡½æ•°`optimizeDeps`å®šä¹‰åœ¨`src/node/optimizer/index.ts`ï¼Œå…¶ä¸»è¦æµç¨‹å¯åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

1. åˆ¤æ–­æ˜¯å¦éœ€è¦é¢„æ„å»ºï¼Œå¦‚æœä¹‹å‰é¢„æ„å»ºçš„å†…å®¹è¿˜å¯ä»¥ç”¨ï¼Œé‚£ä¹ˆç›´æ¥`return`ï¼Œåä¹‹ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚éœ€è¦è¯´æ˜çš„æ˜¯åˆ¤æ–­é¢„æ„å»ºçš„å†…å®¹æ˜¯å¦å¯ç”¨çš„ä¾æ®æ˜¯`package.lock.json`å’Œéƒ¨åˆ† vite é…ç½®çš„å†…å®¹ï¼Œå…·ä½“å®ç°åœ¨`getDepHash`å‡½æ•°ä¸­ã€‚

```

  if (!force) {
    let prevData;
    try {
      prevData = JSON.parse(fs.readFileSync(dataPath, "utf-8"));
    } catch (e) {}
    // hash is consistent, no need to re-bundle
    if (prevData && prevData.hash === data.hash) {
      log("Hash is consistent. Skipping. Use --force to override.");
      return prevData;
    }
  }
```

2. ä½¿ç”¨ esbuild è§£ææ•´ä¸ªé¡¹ç›®ï¼Œè·å–æœ¬æ¬¡éœ€è¦è¿›è¡Œ**é¢„æ„å»ºçš„ä¾èµ–**å’Œ**è§£æå‡ºé—®é¢˜çš„ä¾èµ–**ï¼Œåˆ†åˆ«èµ‹å€¼ç»™`deps`å’Œ`missing`,å…¶ä¸»è¦æ‰§è¡Œè¿‡ç¨‹åœ¨å‡½æ•°`scanImports`ä¸­ï¼ˆè¿™éƒ¨åˆ†çš„ä»£ç å®ç°è¿‡ç¨‹æ¢³ç†æ”¾åœ¨æœ¬éƒ¨åˆ†æœ€åï¼‰ã€‚

```
  let deps: Record<string, string>, missing: Record<string, string>;
  if (!newDeps) {
    ({ deps, missing } = await scanImports(config));
  } else {
    deps = newDeps;
    missing = {};
  }
```

3. æ­£å¼é¢„æ„å»ºå‰çš„ä¸€ç³»åˆ—çš„å¤„ç†
   1. å¦‚æœ`missing`æœ‰å€¼ï¼Œåˆ™æŠ¥é”™,å°±æ˜¯æˆ‘ä»¬åœ¨æ§åˆ¶å°çœ‹åˆ°çš„`The following dependencies are imported but could not be resolved.... Are they installed`
   2. æŠŠé…ç½®é¡¹`config.optimizeDeps?.include`é‡Œçš„ä¾èµ–åŠ å…¥åˆ°`deps`ä¸­,å¦‚æœå¤„ç†å¤±è´¥çš„è¯ä¹Ÿä¼šåœ¨æ§åˆ¶å°æŠ¥é”™
   3. å¦‚æœ`deps`ä¸ºç©ºçš„è¯ï¼Œè¯´æ˜ä¸éœ€è¦é¢„æ„å»ºï¼Œæ›´æ–°é¢„æ„å»ºå†…å®¹çš„ hash å€¼åç›´æ¥`return`
   4. æ‰§è¡Œåˆ°è¿™è¯´æ˜æœ¬æ¬¡éœ€è¦è¿›è¡Œé¢„æ„å»ºï¼Œåœ¨æ§åˆ¶å°æç¤ºæœ¬æ¬¡é¢„æ„å»ºçš„ä¾èµ–,å¦‚ä¸‹å›¾æ‰€ç¤º

![screenshot-20210815-121549.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc320098901141548e2ef47be32a755a~tplv-k3u1fbpfcp-watermark.image) 4. è¿›ä¸€æ­¥å¤„ç†`deps`å¾—åˆ°`flatIdDeps`ï¼Œä¸»è¦æ˜¯å› ä¸ºé»˜è®¤ esbuild æ‰“åŒ…çš„è¯å¯¹äºä¾èµ–çš„åˆ†æã€æ˜ å°„çš„å¤„ç†å¯èƒ½æ¯”è¾ƒéº»çƒ¦,è¿™é‡Œä¸»è¦åšäº†ä¸¤æ–¹é¢çš„å·¥ä½œ

> 1. æ‰å¹³åŒ–ç›®å½•ç»“æ„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¼•å…¥`lib-flexible/flexible`,è€Œé¢„æ„å»ºçš„ä¾èµ–ä¸º`lib-flexible_flexible.js`

![carbon.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57e9f8e7c82044e6b8bc75023f2f85fe~tplv-k3u1fbpfcp-watermark.image)

> 2. åœ¨æ’ä»¶ä¸­ï¼ŒæŠŠå…¥å£æ–‡ä»¶å½“ä½œè™šæ‹Ÿæ–‡ä»¶(è¿™ä¸€æ­¥åº”è¯¥æ˜¯ esbuild æ’ä»¶çš„éœ€è¦ï¼Œä¸æ˜¯ç‰¹åˆ«ç†è§£)

```
// esbuild generates nested directory output with lowest common ancestor base
 // this is unpredictable and makes it difficult to analyze entry / output
 // mapping. So what we do here is:
 // 1. flatten all ids to eliminate slash
 // 2. in the plugin, read the entry ourselves as virtual files to retain the
 //    path.
 const flatIdDeps: Record<string, string> = {};
 const idToExports: Record<string, ExportsData> = {};
 const flatIdToExports: Record<string, ExportsData> = {};

 await init;
 for (const id in deps) {
   const flatId = flattenId(id);
   flatIdDeps[flatId] = deps[id];
   const entryContent = fs.readFileSync(deps[id], "utf-8");
   const exportsData = parse(entryContent) as ExportsData;
   for (const { ss, se } of exportsData[0]) {
     const exp = entryContent.slice(ss, se);
     if (/export\s+\*\s+from/.test(exp)) {
       exportsData.hasReExports = true;
     }
   }
   idToExports[id] = exportsData;
   flatIdToExports[flatId] = exportsData;
 }
```

5.  ä½¿ç”¨ esbuild å¯¹`deps`æ¯ä¸ªä¾èµ–è¿›è¡Œæ„å»ºå¹¶é»˜è®¤è¾“å‡ºåˆ°`node_modules/.vite`ä¸­

```
 const result = await build({
   entryPoints: Object.keys(flatIdDeps),
   bundle: true,
   format: "esm",
   external: config.optimizeDeps?.exclude,
   logLevel: "error",
   splitting: true,
   sourcemap: true,
   outdir: cacheDir,
   treeShaking: "ignore-annotations",
   metafile: true,
   define,
   plugins: [
     ...plugins,
     esbuildDepPlugin(flatIdDeps, flatIdToExports, config),
   ],
   ...esbuildOptions,
 });
```

6. æŠŠæ­¤æ¬¡é¢„æ„å»ºçš„ä¿¡æ¯æ›´æ–°å¹¶å†™å…¥æ–‡ä»¶`node_modules/.vite/_metadata.json`,å®Œæˆé¢„æ„å»ºï¼

```
for (const id in deps) {
    const entry = deps[id];
    data.optimized[id] = {
      file: normalizePath(path.resolve(cacheDir, flattenId(id) + ".js")),
      src: entry,
      needsInterop: needsInterop(
        id,
        idToExports[id],
        meta.outputs,
        cacheDirOutputPath
      ),
    };
  }

  writeFile(dataPath, JSON.stringify(data, null, 2));
```

### `scanImports`

`â€å…·ä½“å“ªäº›ä¾èµ–æ˜¯éœ€è¦é¢„æ„å»ºçš„ï¼Ÿâ€œ`æ˜¯å‡½æ•°`scanImports`å¤„ç†çš„ï¼Œåœ¨`src/node/optimizer/scan.ts`ä¸­ï¼Œå…¶è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå¤§æ¦‚åˆ†ä¸ºä¸¤æ­¥ï¼š

> 1. æ‰¾åˆ°å…¥å£æ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯`index.html`ï¼‰
> 2. ä½¿ç”¨ esbuild è¿›è¡Œä¸€æ¬¡æ‰“åŒ…ï¼Œæ‰“åŒ…è¿‡ç¨‹ä¸­å°±æ‰¾åˆ°äº†`deps`å’Œ`missing`,æœ€åè¿”å›`deps`å’Œ`missing`

```
// step 1
 let entries: string[] = []
 ...
 entries = await globEntries('**/*.html', config)
 ...

// step 2
const plugin = esbuildScanPlugin(config, container, deps, missing, entries)

const { plugins = [], ...esbuildOptions } =
    config.optimizeDeps?.esbuildOptions ?? {}
  await Promise.all(
    entries.map((entry) =>
      build({
        write: false,
        entryPoints: [entry],
        bundle: true,
        format: 'esm',
        logLevel: 'error',
        plugins: [...plugins, plugin],
        ...esbuildOptions
      })
    )
  )

return {
    deps,
    missing
}

```

ç”±ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ`deps`å’Œ`missing`æ˜¯åœ¨ esbuild æ’ä»¶`esbuildScanPlugin`ä¸­å¾—åˆ°çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ’ä»¶æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ

### `esbuildScanPlugin`

è¿˜æ˜¯åœ¨`src/node/optimizer/scan.ts`ä¸­ï¼Œè¯¥æ’ä»¶ä¸»è¦åšäº†ä»¥ä¸‹ä¸¤ä»¶äº‹ï¼š

1. å¤„ç†å¯¼å…¥æ¨¡å—ï¼ˆä¾èµ–ï¼‰ï¼Œåœ¨`build.onResolve`ä¸­ï¼Œå…·ä½“ï¼š
   > 1. è®¾ç½®`external`å±æ€§(external ä»£è¡¨è¯¥æ¨¡å—æ˜¯å¦éœ€è¦æ‰“åŒ…)
   > 2. åˆ¤æ–­æ˜¯å¦åº”è¯¥åŠ å…¥`deps`æˆ–è€…`missing`,ä»£ç å¦‚ä¸‹ï¼š

```
...
export const OPTIMIZABLE_ENTRY_RE = /\.(?:m?js|ts)$/
...
const resolved = await resolve(id, importer)
if (resolved) {
    if (shouldExternalizeDep(resolved, id)) {
      return externalUnlessEntry({ path: id })
    }
    if (resolved.includes('node_modules') || include?.includes(id)) {
      // dependency or forced included, externalize and stop crawling
      if (OPTIMIZABLE_ENTRY_RE.test(resolved)) {
        depImports[id] = resolved
      }
      return externalUnlessEntry({ path: id })
    } else {
      // linked package, keep crawling
      return {
        path: path.resolve(resolved)
      }
    }
} else {
    missing[id] = normalizePath(importer)
}
```

ç”±ä¸Šå¯çŸ¥æ¨¡å—ï¼ˆä¾èµ–ï¼‰æ˜¯å¦æ”¾åœ¨`depsã€missing`é‡Œã€æ”¾çš„è¯æ”¾åœ¨å“ªä¸€ä¸ªéƒ½æ˜¯ç”±å‡½æ•°`resolve`å†³å®šçš„ï¼Œä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°`resolve`çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹:

> 1.  æ‰§è¡Œ rollup çš„ hook `resolveId()`,
> 2.  æ‰§è¡Œ vite çš„æ’ä»¶ pluginContainer `resolveId()`
> 3.  æœ€åæ˜¯è¿™é‡Œçš„`resolve()`
>     ç”±äºæˆ‘å¯¹äºè¿™ä¸€æ®µçš„å¤„ç†é€»è¾‘ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œåªèƒ½ç®€å•çš„ç†è§£ä¸ºï¼š
> 4.  `resolve`å¤±è´¥çš„è¯å°±ä¼šæ”¾åˆ°`missing`
> 5.  `resolve`é‡ŒåŒ…å«`node_modules`(æˆ‘ç†è§£ä¸ºæ”¾åœ¨`node_modules`ç›®å½•ä¸‹)æˆ–è€…åœ¨ vite çš„é…ç½®é¡¹`include`é‡Œä¸”æ˜¯`OPTIMIZABLE_ENTRY_RE`çš„ä¼šç›´æ¥æ”¾è¿›`deps`ç­‰å¾…æ‰“åŒ…ï¼Œä¸å†è¿›ä¸€æ­¥å‘ä¸‹ crawlingã€‚
>     è¿™é‡Œå°±æŠŠé¢„æ„å»ºéœ€è¦çš„`deps`å’Œ`missing`æ”¶é›†åˆ°äº†ã€‚

2. å¤„ç†æ–‡ä»¶å†…å®¹ï¼Œåœ¨`build.onLoad`ä¸­ï¼Œå…·ä½“ï¼š
   > 1. é’ˆå¯¹`.html .vue svelte`è¿™ç±»æœ‰ js é€»è¾‘çš„æ–‡ä»¶ï¼Œéœ€è¦æŠŠå…¶ä¸­çš„ js éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥ï¼Œä½¿ç”¨`import ã€export`è¯­æ³•åŒ…è£¹å¹¶è¿”å›
   > 2. é’ˆå¯¹ä¸åŒçš„æ–‡ä»¶(jsã€tsã€jsx...)ï¼ŒåŠ è½½ä¸åŒçš„ loader è§£æ

## é¢„æ„å»ºçš„ç»“æœ

é¢„æ„å»ºçš„ç»“æœéƒ½æ”¾åœ¨äº†`node_modules/.vite/`ä¸­ï¼Œä¸€èˆ¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒ…æ‹¬ä¸¤æ–¹é¢çš„ä¿¡æ¯ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef42742aec2a4761ab9407bb0981db79~tplv-k3u1fbpfcp-watermark.image)

1. `_metadata.json`,æ˜¯æœ¬æ¬¡é¢„æ„å»ºäº§ç”Ÿçš„ä¸€äº›â€œç‰ˆæœ¬â€å’Œä¾èµ–åŒ…çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
   ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/58853028be964607848d240ae6341915~tplv-k3u1fbpfcp-watermark.image)
2. `xx.js, xxx.js.map`å„ä¸ªä¾èµ–åŒ…çš„æ‰“åŒ…ç»“æœ

## END

é¢„æ„å»ºéƒ¨åˆ†çš„ä»£ç å®ç°å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œæ–‡ç« åŒæ­¥æ”¾åœ¨äº†[vite æºç é˜…è¯»](https://github.com/wkstudy/doc/tree/master/vite)ä¸­ï¼Œå…³äº vite æºç ç›¸å…³çš„å­¦ä¹ éƒ½ä¼šè®°å½•åœ¨è¿™é‡Œï¼Œæ¬¢è¿å¤§å®¶è®¨è®ºäº¤æµï¼Œæ„Ÿè°¢å„ä½ ğŸ™
